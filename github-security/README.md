# Github


## Pre-requsite

We will use Ubuntu WSK

Modify (WLS) ir create (ubuntu). `/etc/resolv.conf` file if DNS issues

````
sudo cat /etc/resolv.conf 
change nameserver to 8.8.8.8
````

So that

````
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 8.8.8.8
````


## Account security

We can have 2 Factor authentification with Microsoft authentificator.
We should store recovery key in a safe place.
We can add as additional method a Yubico or Github app istelf.

## OAuth app 

https://github.com/settings/developers

See [oauth](../oauth/README.md)

<!-- do not explore -->

## Repository push right 

### Personal access token 

In `setting > developer settings`:
https://github.com/settings/tokens

When pushing code usermame is you github username and password is the token.

### SSH Keys

This is linked to [tls](../tls/tls-certificate.md#complements) which refers to  [SSH certificate](../lab-env/README.md#ssh-summary).

#### Generate key pair

Ref: https://docs.github.com/en/authentication/connecting-to-github-with-ssh

````
ssh-keygen -t ed25519 -C "s******bel@gmail.com"
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
````

#### Copy ssh key in github

Ref: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account



````
cat ~/.ssh/id_ed25519.pub
````

and copy at  https://github.com/settings/keys

#### Test ssh

Ref: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/testing-your-ssh-connection

````
ssh -T git@github.com
````


We did not explore SSH key storing in Yubico.

### Push 

**When pushing ensure you use a ssh remote**

````
git remote add origin git@github.com:scoulomb/git-secret-test.git
git push
````

See https://stackoverflow.com/questions/46337566/why-is-github-asking-me-username-password-although-i-setup-ssh-authentication

 
## Sign your commit

We will use PGP public/private key (a variant of openSSL) see in [tls](../tls/in-learning-complement/learning-ssl-tld.md#linux-openssl-pki-environment).

<!--
See here application in PKI (aka X509, TLS absuively) cert:https://www.gnupg.org/documentation/manuals/gnupg.pdf
-->

### Enable vigilant mode

https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits

### Generate GPG keys

https://docs.github.com/en/authentication/managing-commit-signature-verification/generating-a-new-gpg-key

````
gpg --full-generate-key
````

We can list keys 

````
gpg --list-keys
gpg --list-secret-keys
gpg --list-keys --keyid-format=long
````

We can manipulate key via pub (part after `rsa3072`/ long format) or uid.

And in particular export generated key via

````
gpg --armor --export scoulomb > public.key
gpg --armor --export-secret-key scoulomb > private.key
````

<!-- note --armor is equivalent -a, for ASCII rmored output -->

It is important if we want to store key-pair in KeePass to import them later as this

````
gpg --delete-key scoulomb
gpg --delete-secret-key scoulomb


gpg --list-keys
gpg --list-secret-keys 

gpg --import public.key # <- only that is needed if encrypt only / to check signature
gpg --import private.key # <- to be able to decrypt / to sign
````

See [Asymetric cryptography](../tls/tls-certificate.md#asymetric-cryptography-we-generate-two-keys-key1-and-key2) and [digital signature](../tls/in-learning-complement/learning-ssl-tld.md#digital-signature).


### Configure git and github

#### We can import the public key in github

````
gpg --armor --export -a scoulomb 
````

and copy output to https://github.com/settings/keys


#### We should also tell git (local) our signing key

````
gpg --list-secret-keys --keyid-format=long
git config --global user.signingkey D971D49847B3D83F
````

And can try 

````
mkdir test-repo
echo "# git-secret-test" >> README.md
git init
git add README.md
git commit -m "first commit"
git branch -M main
git remote add origin git@github.com:scoulomb/git-secret-test.git
git push -u origin main
echo "# git-secret-test 42" >> README.md
git add README.md
git commit -m "second commit"
git push 
echo "# git-secret-test 44" >> README.md
git add README.md
git commit -S -m "third commit"
git push -u origin main
git push
````

Note that GPG key have to match your committer identity and your verified email address associated with your account on GitHub.com.

See https://docs.github.com/en/authentication/managing-commit-signature-verification/associating-an-email-with-your-gpg-key


Rather than doing `git commit -S -m "third commit"`.
We can sign by default: https://stackoverflow.com/questions/10161198/is-there-a-way-to-autosign-commits-in-git-with-a-gpg-key

````
git config --global commit.gpgSign true
````

Github does not support signed push `git push -S`, only signed commit.



#### Troubleshooting

We faced following issue

````
~/test-repo$ git commit -S -m "fff" --amend
error: gpg failed to sign the data
fatal: failed to write commit object
````

quoting https://stackoverflow.com/questions/39494631/gpg-failed-to-sign-the-data-fatal-failed-to-write-commit-object-git-2-10-0


> Follow the below url to setup signed commit 
https://help.github.com/en/articles/telling-git-about-your-signing-key

> if still getting 
gpg failed to sign the data fatal: 
failed to write commit object

> this is not issue with git ,this is with GPG
follow below steps


> 1. `gpg --version`
> 2. `echo "test" | gpg --clearsign`

> if it is showing:


```
gpg: signing failed: Inappropriate ioctl for device
gpg: [stdin]: clear-sign failed: Inappropriate ioctl for device

```

> 3. then use `export GPG_TTY=$(tty)`
> 4. then again try `echo "test" | gpg --clearsign`
> in which PGP signature is got.

> 5. `git config -l | grep gpg`

```
gpg.program=gpg
commit.gpgsign=true
````
> 6. apply `git commit -S -m "commitMsz"`



We can update permanently `.bashrc`, `$(tty)` may chnage value

````
echo "export GPG_TTY=$(tty)" >> ~/.bashrc
````

We will descativate signed commit 

````
git config --global commit.gpgSign false
````

## git secret

### Prereq

Git secret also leverages GPG keys

- Setup: https://git-secret.io/installation (use Debian setup).
- Then see [GPG key generation](#generate-gpg-keys).
<!-- in generate gpg key we show export to store in keepass, but normallly you do need as in here: https://git-secret.io/ -->

### Usage

#### Self 

See https://git-secret.io/

We setup the repo 

````
rm -rf ~/secret-test-repo
mkdir ~/secret-test-repo
cd  ~/secret-test-repo

echo "# git-secret-test" >> README.md
git init
git add README.md
git commit -m "first commit"
git branch -M main
git remote add origin git@github.com:scoulomb/git-secret-test.git
git push -u origin main -f

git secret init
git secret tell sylvaincoulombel@gmail.com
git add .gitsecret
git commit -m "git secret setup"
git push -u origin main -f
````

and add encrypted file

````
echo "# git-secret-test - file_to_encrypt" >> FILE_TO_ENCRYPT.md
git secret add FILE_TO_ENCRYPT.md # see cat .gitignore, (as of 0.2.6) add entries to .gitignore, stopping those files from being be added or committed to the repo unencrypted.
git secret hide # cloud do a pre-commit hook
````

Then git status

````
~/secret-test-repo$ git status
On branch main
Your branch is up to date with 'origin/main'.

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        .gitignore
        .gitsecret/
        FILE_TO_ENCRYPT.md.secret

nothing added to commit but untracked files present (use "git add" to track)
~/secret-test-repo$ ll | grep FILE
-rw-r--r--  1 scoulomb scoulomb   36 Jun 24 13:29 FILE_TO_ENCRYPT.md
-rw-r--r--  1 scoulomb scoulomb  514 Jun 24 13:29 FILE_TO_ENCRYPT.md.secret
scoulomb@NCEL96011:~/secret-test-repo$ git secret cat FILE_TO_ENCRYPT.md
# git-secret-test - file_to_encrypt
````

after we do add

````
git add FILE_TO_ENCRYPT.md.secret
git commit -m "second commit"
git push --force
````

and pull it from another repo

````
rm -rf ~/secret-test-repo-pull
git clone git@github.com:scoulomb/git-secret-test.git ~/secret-test-repo-pull
cd ~/secret-test-repo-pull
ll
cat FILE_TO_ENCRYPT.md.secret
git secret cat FILE_TO_ENCRYPT.md.secret
git secret reveal FILE_TO_ENCRYPT.md # no .secret extension
````

Unfortuanately we can not git secret add on full folder.
Thus not convenient for private_repo.
But we can do 

````
for file in *
do
  git add "$file"
done

````

#### Adding someone to a repository using git-secret

https://git-secret.io/

> 1. Get their gpg public-key. You won’t need their secret key. They can export their public key for you using a command like: gpg --armor --export their@email.id > public_key.txt # --armor here makes it ascii

> 2. Import this key into your gpg keyring (in ~/.gnupg or similar) by running gpg --import public_key.txt

Exactly as what we explained in [generate gpg key section](#generate-gpg-keys) for keepass storing.

> 3. Now add this person to your secrets repo by running git secret tell their@email.id (this will be the email address associated with their public key)

> 4. Now remove the other user’s public key from your personal keyring with gpg --delete-keys their@email.id

> 5. The newly added user cannot yet read the encrypted files. Now, re-encrypt the files using git secret reveal; git secret hide -d, and then commit and push the newly encrypted files. (The -d options deletes the unencrypted file after re-encrypting it). Now the newly added user will be able to decrypt the files in the repo using git-secret reveal.

Note that when this user will reveal, he will use its local private key.

<!-- above ok, hook ok, soluce priv repo other -->

## Use gpg encryption directly

See https://statistics.berkeley.edu/computing/encrypt

````
gpg -e -r scoulomb ~/secret-test-repo/FILE_TO_ENCRYPT.md
gpg -d -o ~/file_decrypted.md  ~/secret-test-repo/FILE_TO_ENCRYPT.md.gpg
````

But diff is difficult

````
$gpg -e -r scoulomb -o  ~/secret-test-repo/FILE_TO_ENCRYPT1.md.gpg  ~/secret-test-repo/FILE_TO_ENCRYPT.md
$gpg -e -r scoulomb -o  ~/secret-test-repo/FILE_TO_ENCRYPT2.md.gpg  ~/secret-test-repo/FILE_TO_ENCRYPT.md

$ diff ~/secret-test-repo/FILE_TO_ENCRYPT1.md.gpg ~/secret-test-repo/FILE_TO_ENCRYPT2.md.gpg
Binary files /home/scoulomb/secret-test-repo/FILE_TO_ENCRYPT1.md.gpg and /home/scoulomb/secret-test-repo/FILE_TO_ENCRYPT2.md.gpg differ

````

If error do also here

````
export GPG_TTY=$(tty)
````

## SSH certificates

In github here: https://github.com/organizations/open-denon-heos/settings/security

We can define for org, SSH Certificate CA.

It is  a PKI (aka TLS but PKI more accurate) certificate CA as seen in [TLS section](../tls/tls-certificate.md#complements) and applied to [SSH certificate](../lab-env/README.md#add-ssh).
SSH cert have to be signed by SSH cert CA.

From https://smallstep.com/blog/use-ssh-certificates/

> It avoid key distribution: ~/.ssh/authorized_keys are no longer needed. Instead, peers (server) learn one another’s public keys on demand, when connections are established, by exchanging certificates. 
Once certificates have been exchanged the protocol proceeds as it would with public key authentication.

Meaning that if cert is trusted (chain...), we add the public key in cert in equivalent of cert in Authorized key.
Note we leverage TLS certif exchange.

<!-- OK -->
<!-- ALL OK -->